name: Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'minor'
        type: choice
        options:
        - none
        - patch
        - minor
        - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install semver
      run: |
        echo "Installing semver tool..."
        if ! npm install -g semver; then
          echo "Error: Failed to install semver tool"
          exit 1
        fi
        
        # Verify installation
        if ! command -v semver &> /dev/null; then
          echo "Error: semver tool not found after installation"
          exit 1
        fi
        
        echo "✓ semver tool installed successfully"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1

    - name: Verify AWS authentication
      run: |
        echo "Verifying AWS authentication..."
        
        # Test AWS credentials
        if ! aws sts get-caller-identity > /dev/null 2>&1; then
          echo "Error: AWS authentication failed"
          exit 1
        fi
        
        echo "✓ AWS authentication successful"

    - name: Login to Amazon ECR Public
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registry-type: public

    - name: Verify ECR authentication
      run: |
        echo "Verifying ECR public registry authentication..."
        
        # Test ECR authentication by attempting to describe repositories
        if ! aws ecr-public describe-repositories --region us-east-1 > /dev/null 2>&1; then
          echo "Error: ECR public registry authentication failed"
          exit 1
        fi
        
        echo "✓ ECR public registry authentication successful"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install OpenShift CLI
      run: |
        echo "Installing OpenShift CLI..."
        
        # Download with retry logic
        for i in {1..3}; do
          if curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz; then
            break
          elif [ $i -eq 3 ]; then
            echo "Error: Failed to download OpenShift CLI after 3 attempts"
            exit 1
          else
            echo "Download attempt $i failed, retrying..."
            sleep 5
          fi
        done
        
        tar -xzf openshift-client-linux.tar.gz
        sudo mv oc /usr/local/bin/
        
        # Verify installation
        if ! oc version --client; then
          echo "Error: OpenShift CLI installation failed"
          exit 1
        fi
        
        echo "✓ OpenShift CLI installed successfully"

    - name: Bump version
      run: |
        echo "Processing version bump..."
        
        # Validate VERSION file exists and is readable
        if [[ ! -f "VERSION" ]]; then
          echo "Error: VERSION file not found"
          exit 1
        fi
        
        CURRENT_VERSION=$(cat VERSION)
        if [[ -z "$CURRENT_VERSION" ]]; then
          echo "Error: VERSION file is empty"
          exit 1
        fi
        
        echo "Current version: $CURRENT_VERSION"
        
        # Validate current version format
        if ! semver "$CURRENT_VERSION" > /dev/null 2>&1; then
          echo "Error: Current version '$CURRENT_VERSION' is not a valid semantic version"
          exit 1
        fi
        
        if [ "${{ inputs.bump_type }}" = "none" ]; then
          NEW_VERSION=$CURRENT_VERSION
          echo "Using current version: $NEW_VERSION"
        else
          echo "Bumping version with type: ${{ inputs.bump_type }}"
          
          if ! NEW_VERSION=$(semver -i ${{ inputs.bump_type }} $CURRENT_VERSION); then
            echo "Error: Failed to bump version from $CURRENT_VERSION"
            exit 1
          fi
          
          echo $NEW_VERSION > VERSION
          echo "Bumped version from $CURRENT_VERSION to $NEW_VERSION"
        fi
        
        # Validate new version
        if [[ -z "$NEW_VERSION" ]]; then
          echo "Error: New version is empty"
          exit 1
        fi
        
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "✓ Version processing completed: $NEW_VERSION"

    - name: Build and push images
      run: |
        echo "Building and pushing images for version: ${{ env.NEW_VERSION }}"
        
        # Build operator image
        echo "Building operator image..."
        if ! make docker-build PROJECT_VERSION=${{ env.NEW_VERSION }}; then
          echo "Error: Failed to build operator image"
          exit 1
        fi
        echo "✓ Operator image built and pushed successfully"
        
        # Generate bundle
        echo "Generating OLM bundle..."
        if ! make bundle PROJECT_VERSION=${{ env.NEW_VERSION }}; then
          echo "Error: Failed to generate bundle"
          exit 1
        fi
        echo "✓ Bundle generated successfully"
        
        # Build bundle image
        echo "Building bundle image..."
        if ! make bundle-build PROJECT_VERSION=${{ env.NEW_VERSION }}; then
          echo "Error: Failed to build bundle image"
          exit 1
        fi
        echo "✓ Bundle image built and pushed successfully"
        
        # Build index image
        echo "Building index image..."
        if ! make index PROJECT_VERSION=${{ env.NEW_VERSION }}; then
          echo "Error: Failed to build index image"
          exit 1
        fi
        echo "✓ Index image built and pushed successfully"
        
        echo "✓ All images built and pushed successfully"

    - name: Generate release manifests
      run: |
        echo "Generating release manifests for version: ${{ env.NEW_VERSION }}"
        
        if ! make release-manifests PROJECT_VERSION=${{ env.NEW_VERSION }}; then
          echo "Error: Failed to generate release manifests"
          exit 1
        fi
        
        # Validate generated manifests
        EXPECTED_FILES=(
          "release/${{ env.NEW_VERSION }}/aws-neuron-operator.yaml"
          "release/${{ env.NEW_VERSION }}/nfd-rule.yaml"
          "release/${{ env.NEW_VERSION }}/deviceconfig-sample.yaml"
        )
        
        for file in "${EXPECTED_FILES[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "Error: Missing expected manifest file: $file"
            exit 1
          fi
          
          if [[ ! -s "$file" ]]; then
            echo "Error: Manifest file is empty: $file"
            exit 1
          fi
          
          echo "✓ Validated: $file"
        done
        
        echo "✓ Release manifests generated and validated successfully"



    - name: Commit and tag
      run: |
        echo "Configuring git and creating release tag..."
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        CURRENT_BRANCH=$(git branch --show-current)
        echo "Current branch: $CURRENT_BRANCH"
        
        # Check if tag already exists
        if git tag -l "v${{ env.NEW_VERSION }}" | grep -q "v${{ env.NEW_VERSION }}"; then
          echo "Error: Tag v${{ env.NEW_VERSION }} already exists"
          exit 1
        fi
        
        # Commit version change if needed
        if [ "${{ inputs.bump_type }}" != "none" ]; then
          echo "Committing version change..."
          
          if ! git add VERSION; then
            echo "Error: Failed to stage VERSION file"
            exit 1
          fi
          
          if ! git commit -m "Bump version to ${{ env.NEW_VERSION }}"; then
            echo "Error: Failed to commit version change"
            exit 1
          fi
          
          echo "✓ Version change committed"
        fi
        
        # Create tag
        echo "Creating tag v${{ env.NEW_VERSION }}..."
        if ! git tag "v${{ env.NEW_VERSION }}"; then
          echo "Error: Failed to create tag"
          exit 1
        fi
        
        # Push changes with retry logic
        echo "Pushing changes to remote..."
        for i in {1..3}; do
          if git push origin $CURRENT_BRANCH && git push origin "v${{ env.NEW_VERSION }}"; then
            echo "✓ Changes pushed successfully"
            break
          elif [ $i -eq 3 ]; then
            echo "Error: Failed to push changes after 3 attempts"
            exit 1
          else
            echo "Push attempt $i failed, retrying..."
            sleep 5
          fi
        done

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ env.NEW_VERSION }}"
        name: "Release v${{ env.NEW_VERSION }}"
        body: |
          ## AWS Neuron Operator v${{ env.NEW_VERSION }}
          
          ### Quick Install
          ```bash
          kubectl apply -f https://github.com/awslabs/operator-for-ai-chips-on-aws/releases/download/v${{ env.NEW_VERSION }}/aws-neuron-operator.yaml
          kubectl apply -f https://github.com/awslabs/operator-for-ai-chips-on-aws/releases/download/v${{ env.NEW_VERSION }}/deviceconfig-sample.yaml
          ```
          
          ### Container Images
          
          **Direct Installation:**
          - Operator: `public.ecr.aws/q5p6u7h8/neuron-openshift/operator:v${{ env.NEW_VERSION }}`
          
          **OLM Installation:**
          - Bundle: `public.ecr.aws/q5p6u7h8/neuron-openshift/operator-bundle:v${{ env.NEW_VERSION }}`
          - Index: `public.ecr.aws/q5p6u7h8/neuron-openshift/operator-index:v${{ env.NEW_VERSION }}`
          
          ### Installation Methods
          
          **Option 1: Direct Install (Recommended)**
          ```bash
          # Install NFD and KMM operators from OperatorHub first
          kubectl apply -f https://github.com/awslabs/operator-for-ai-chips-on-aws/releases/download/v${{ env.NEW_VERSION }}/aws-neuron-operator.yaml
          kubectl apply -f https://github.com/awslabs/operator-for-ai-chips-on-aws/releases/download/v${{ env.NEW_VERSION }}/deviceconfig-sample.yaml
          ```
          
          **Option 2: OLM Install**
          ```bash
          # 1. Apply NFD rule first
          kubectl apply -f https://github.com/awslabs/operator-for-ai-chips-on-aws/releases/download/v${{ env.NEW_VERSION }}/nfd-rule.yaml
          
          # 2. Create namespace
          kubectl create namespace ai-operator-on-aws
          
          # 3. Create OperatorGroup
          kubectl apply -f - <<EOF
          apiVersion: operators.coreos.com/v1
          kind: OperatorGroup
          metadata:
            name: aws-neuron-operator
            namespace: ai-operator-on-aws
          EOF
          
          # 4. Create CatalogSource
          kubectl apply -f - <<EOF
          apiVersion: operators.coreos.com/v1alpha1
          kind: CatalogSource
          metadata:
            name: aws-neuron-operator
            namespace: openshift-marketplace
          spec:
            sourceType: grpc
            image: public.ecr.aws/q5p6u7h8/neuron-openshift/operator-index:v${{ env.NEW_VERSION }}
            displayName: AWS Neuron Operator Catalog
          EOF
          
          # 5. Create Subscription
          kubectl apply -f - <<EOF
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: aws-neuron-operator-sub
            namespace: ai-operator-on-aws
          spec:
            channel: "alpha"
            installPlanApproval: Automatic
            name: aws-neuron-operator
            source: aws-neuron-operator
            sourceNamespace: openshift-marketplace
          EOF
          ```
          
          See [INSTALL.md](https://github.com/awslabs/operator-for-ai-chips-on-aws/blob/main/INSTALL.md) for detailed instructions.
        files: |
          release/${{ env.NEW_VERSION }}/aws-neuron-operator.yaml
          release/${{ env.NEW_VERSION }}/nfd-rule.yaml
          release/${{ env.NEW_VERSION }}/deviceconfig-sample.yaml
        generate_release_notes: true